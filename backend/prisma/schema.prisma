// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  BUYER
  PROBLEM_SOLVER
}

enum ProjectStatus {
  OPEN
  REQUESTED
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  COMPLETED
  REJECTED
}

enum TaskStatus {
  CREATED
  IN_PROGRESS
  SUBMITTED
  COMPLETED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  password                String
  name                    String
  role                    Role      @default(PROBLEM_SOLVER)
  verified                Boolean   @default(false)
  lastSeenNotificationsAt DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // As Buyer
  ownedProjects Project[] @relation("ProjectOwner")

  // As Assigned Solver
  assignedProjects Project[] @relation("AssignedSolver")

  // Work requests
  projectRequests ProjectRequest[]

  @@index([email])
  @@index([role])
}

model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      ProjectStatus @default(OPEN)
  buyerId     String
  solverId    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  buyer  User   @relation("ProjectOwner", fields: [buyerId], references: [id], onDelete: Cascade)
  solver User?  @relation("AssignedSolver", fields: [solverId], references: [id], onDelete: SetNull)

  requests ProjectRequest[]
  tasks    Task[]

  @@index([buyerId])
  @@index([solverId])
  @@index([status])
}

model ProjectRequest {
  id        String        @id @default(cuid())
  projectId String
  userId    String
  status    RequestStatus @default(PENDING)
  message   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Task {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  status      TaskStatus @default(CREATED)
  orderIndex  Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  submissions TaskSubmission[]

  @@index([projectId])
  @@index([status])
}

model TaskSubmission {
  id         String           @id @default(cuid())
  taskId     String
  filePath   String
  fileName   String
  fileSize   Int
  status     SubmissionStatus @default(PENDING)
  feedback   String?
  reviewedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([status])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // TASK_SUBMISSION
  projectId String
  taskId    String?
  title     String
  solverName String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
